# 大二层网络

标签（空格分隔）： 大二层 网络

---

## [剖析大二层](http://www.h3c.com.cn/About_H3C/Company_Publication/IP_Lh/2012/06/Home/Catalog/201212/769073_30008_0.htm)

在**数据中心**和**云计算**的网络方案和技术讨论中，大二层已经成为热点话题，涌现了各种软件和硬件技术、直接和间接手段等，目的都是为了解决“**L2 over XX**”的问题。那么，为什么有这么多大二层技术？在数据中心方案规划和设计中该如何选择？本文进行一个总体的剖析，并在后续的文章中就主要技术与应用进行详细的分析和介绍。

### 为什么需要大二层

#### 1. 虚拟化对数据中心提出的挑战

**传统的三层数据中心架构结构的设计**是为了应付服务**客户端-服务器**应用程序的纵贯式大流量，同时使网络管理员能够对流量流进行管理。工程师在这些架构中采用**生成树协议(STP)**来优化客户端到服务器的路径和支持连接冗余。

虚拟化从根本上改变了数据中心网络架构的需求。最重要的一点就是，虚拟化引入了**虚拟机动态迁移技术**。从而**要求网络支持大范围的二层域**。从根本上改变了传统三层网络统治数据中心网络的局面。

#### 2. 虚拟机迁移与数据中心二层网络的变化

在**传统的**数据中心服务器区**网络设计**中，通常**将二层网络的范围限制在网络接入层以下**（即**传统的二层网络**），避免出现大范围的二层广播域。

如图1所示，由于传统的数据中心服务器利用率太低，平均只有10%～15%，浪费了大量的电力能源和机房资源。虚拟化技术能够有效地提高服务器的利用率，降低能源消耗，降低客户的运维成本，所以虚拟化技术得到了极大的发展。但是，虚拟化给数据中心带来的不仅是服务器利用率的提高，还有网络架构的变化。具体的来说，虚拟化技术的一项伴生技术—**虚拟机动态迁移**（如VMware的VMotion）在数据中心得到了广泛的应用。简单来说，虚拟机迁移技术可以使数据中心的计算资源得到灵活的调配，进一步提高虚拟机资源的利用率。但是**虚拟机迁移要求虚拟机迁移前后的IP和MAC地址不变，这就需要虚拟机迁移前后的网络处于同一个二层域内部**。由于客户要求虚拟机迁移的范围越来越大，甚至是跨越不同地域、不同机房之间的迁移，所以使得数据中心二层网络的范围越来越大，甚至出现了专业的大二层网络这一新领域专题。

![](http://www.h3c.com.cn/res/201212/24/20121224_1501692_image001_769073_30008_0.jpg)

#### 3. 传统网络的二层为什么大不起来

在数据中心网络中，“**区域**”对应VLAN的划分。

- **相同VLAN内**的终端属于同一广播域，具有一致的VLAN-ID，二层连通；
- **不同VLAN内**的终端需要通过网关互相访问，二层隔离，三层连通。

传统的数据中心设计，区域和VLAN的划分粒度是比较细的，这主要取决于“需求”和“网络规模”。

传统的数据中心主要是**依据功能进行区域划分**，例如WEB、APP、DB，办公区、业务区、内联区、外联区等等。不同区域之间通过网关和安全设备互访，保证不同区域的可靠性、安全性。同时，不同区域由于具有不同的功能，因此需要相互访问数据时，只要终端之间能够通信即可，并不一定要求通信双方处于同一VLAN或二层网络。

（在）传统的数据中心网络技术（中）， STP是二层网络中非常重要的一种协议。用户构建网络时，为了保证可靠性，通常会采用冗余设备和冗余链路，这样就**不可避免的形成环路**。而（当）二层网络处于同一个广播域下，广播报文在环路中会反复持续传送，**形成广播风暴**，瞬间即可导致端口阻塞和设备瘫痪。因此，为了防止广播风暴，就必须防止形成环路。这样，既要防止形成环路，又要保证可靠性，就只能将冗余设备和冗余链路变成备份设备和备份链路。**即冗余的设备端口和链路在正常情况下被阻塞掉，不参与数据报文的转发。只有当前转发的设备、端口、链路出现故障，导致网络不通的时候，冗余的设备端口和链路才会被打开，使得网络能够恢复正常。**实现这些自动控制功能的就是**STP（Spanning Tree Protocol，生成树协议）**。

由于**STP的收敛性能**等原因，**一般情况下STP的网络规模不会超过100台交换机**。同时由于STP需要阻塞掉冗余设备和链路，也降低了网络资源的带宽利用率。因此在实际网络规划时，从转发性能、利用率、可靠性等方面考虑，会**尽可能控制STP网络范围**。

#### 4. 大二层也是为了流通的要求

随着数据大集中的发展和虚拟化技术的应用，数据中心的规模与日俱增，不仅对二层网络的区域范围要求也越来越大，在需求和管理水平上也提出了新的挑战。

数据中心区域规模和业务处理需求的增加，对于集群处理的应用越来越多，集群内的服务器需要在一个二层VLAN下。同时，虚拟化技术的应用，在带来业务部署的便利性和灵活性基础上，虚拟机的迁移问题也成为必须要考虑的问题。**为了保证虚拟机承载业务的连续性，虚拟机迁移前后的IP地址不变，因此虚拟机的迁移范围需要在同一个二层VLAN下。反过来即，二层网络规模有多大，虚拟机才能迁移有多远。**

传统的基于STP备份设备和链路方案已经不能满足数据中心规模、带宽的需求，并且**STP协议几秒至几分钟的故障收敛时间**，也不能满足数据中心的可靠性要求。因此，需要能够有新的技术，在满足二层网络规模的同时，也能够充分利用冗余设备和链路，提升链路利用率，而且数据中心的故障收敛时间能够降低到亚秒甚至毫秒级。

### 大二层需要有多大

既然二层网络规模需要扩大，那么大到什么程度合适？这取决于应用场景和技术选择。

#### 1. 数据中心内

大二层首先需要解决的是数据中心内部的网络扩展问题，通过大规模二层网络和VLAN延伸，实现虚拟机在数据中心内部的大范围迁移。由于**数据中心内的大二层网络都要覆盖多个接入交换机和核心交换机**，主要有以下两类技术。

- **虚拟交换机技术**

虚拟交换机技术的出发点很简单，属于**工程派**。既然**二层网络的核心是环路问题**，而环路问题是随着冗余设备和链路产生的，那么如果将相互冗余的两台或多台设备、两条或多条链路合并成一台设备和一条链路，就可以回到之前的单设备、单链路情况，环路自然也就不存在了。尤其是交换机技术的发展，虚拟交换机从低端盒式设备到高端框式设备都已经广泛应用，具备了相当的成熟度和稳定度。因此，**虚拟交换机技术成为目前应用最广的大二层解决方案**。

虚拟交换机技术的代表是**H3C公司的IRF**、**Cisco公司的VSS**，其特点是只需要交换机软件升级即可支持，应用成本低，部署简单。目前这些技术都是各厂商独立实现和完成的，只能同一厂商的相同系列产品之间才能实施虚拟化。同时，由于高端框式交换机的性能、密度越来越高，对虚拟交换机的技术要求也越来越高，目前框式交换机的虚拟化密度最高为4:1。**虚拟交换机的密度限制了二层网络的规模大约在1万～2万台服务器左右。**

- **隧道技术**

隧道技术属于**技术派**，出发点是借船出海。二层网络不能有环路，冗余链路必须要阻塞掉，但三层网络显然不存在这个问题，而且还可以做**ECMP（等价链路）**，能否借用过来呢？通过**在二层报文前插入额外的帧头**，并且**采用路由计算的方式控制整网数据的转发**，不仅可以在冗余链路下防止广播风暴，而且可以做ECMP。这样可以将二层网络的规模扩展到整张网络，而**不会受核心交换机数量的限制**。

隧道技术的代表是**TRILL**、**SPB**，都是通过借用IS-IS路由协议的计算和转发模式，实现二层网络的大规模扩展。这些技术的特点是**可以构建比虚拟交换机技术更大的超大规模二层网络**（应用于大规模集群计算），但尚未完全成熟，目前正在标准化过程中。同时传统交换机不仅需要软件升级，还需要硬件支持。

#### 2. 跨数据中心

随着数据中心多中心的部署，虚拟机的跨数据中心迁移、灾备，跨数据中心业务负载分担等需求，使得二层网络的扩展不仅是在数据中心的边界为止，还需要考虑跨越数据中心机房的区域，延伸到同城备份中心、远程灾备中心。

**一般情况下，多数据中心之间的连接是通过路由连通的，天然是一个三层网络**。而要实现通过三层网络连接的两个二层网络互通，就必须实现“**L2 over L3**”。

**L2oL3技术**也有许多种，例如传统的**VPLS（MPLS L2VPN）技术**，以及新兴的Cisco **OTV**、H3C **EVI技术**，都是借助隧道的方式，将二层数据报文封装在三层报文中，跨越中间的三层网络，实现两地二层数据的互通。这种隧道就像一个虚拟的桥，将多个数据中心的二层网络贯穿在一起。

另外，也有部分虚拟化和软件厂商提出了**软件的L2 over L3技术解决方案**。例如VMware的**VXLAN**、微软的**NVGRE**，在虚拟化层的vSwitch中将二层数据封装在UDP、GRE报文中，在物理网络拓扑上构建一层虚拟化网络层，从而摆脱对网络设备层的二层、三层限制。这些技术由于性能、扩展性等问题，也没有得到广泛的使用。

### 结束语

大规模二层网络的需求目前已经非常的清晰，各厂商都提出了有针对性的技术和方案，满足大二层的当前要求和未来扩展需求。但从实际应用情况来看，除了虚拟交换机技术在成熟度和应用性方面得到验证，其他的相关技术仍然在完善过程中。同时，业界也希望加快相关技术的标准化进程，从而加强各厂商设备的兼容性和互通性，降低用户的部署和维护成本。
